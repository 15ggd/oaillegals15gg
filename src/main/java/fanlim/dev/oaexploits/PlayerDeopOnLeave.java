package fanlim.dev.oaexploits;

import net.md_5.bungee.api.ChatColor;
import org.bukkit.Bukkit;
import org.bukkit.GameMode;
import org.bukkit.Location;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.plugin.java.JavaPlugin;

import java.util.Set;
import java.util.logging.Level;
import java.util.stream.Collectors;

public class PlayerDeopOnLeave implements Listener {

    private final Oaexploits plugin;

    public PlayerDeopOnLeave(Oaexploits plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onPlayerQuit(PlayerQuitEvent event) {
        handlePlayerDeop(event.getPlayer());
    }

    public void handlePlayerDeop(Player player) {
        if (!plugin.getConfig().getBoolean("deop-on-leave.enabled")) {
            return;
        }

        Set<String> whitelist = plugin.getConfig().getStringList("deop-on-leave.whitelist.players").stream()
                .map(String::toLowerCase)
                .collect(Collectors.toSet());

        if (player.isOp() && !whitelist.contains(player.getName().toLowerCase())) {
            // Log the action
            plugin.getLogger().log(Level.INFO, "Deopping player {0} and clearing inventory on leave.", player.getName());

            // Deop the player
            player.setOp(false);

            // Clear the player's inventory
            player.getInventory().clear();

            // Teleport the player to the configured location
            Location targetLocation = getTargetLocation();
            player.teleport(targetLocation);

            // Change the player's game mode to survival to avoid complications when teleporting
            player.setGameMode(GameMode.SURVIVAL);

            // Send configurable message to the player
            String message = plugin.getConfig().getString("deop-on-leave.message", "&cYou have been deopped, your inventory cleared, and you have been teleported to the spawn point.");
            player.sendMessage(ChatColor.translateAlternateColorCodes('&', message));
        }
    }

    private Location getTargetLocation() {
        String worldName = plugin.getConfig().getString("deop-on-leave.teleport.world", "world");
        double x = plugin.getConfig().getDouble("deop-on-leave.teleport.x", 0.0);
        double y = plugin.getConfig().getDouble("deop-on-leave.teleport.y", 64.0);
        double z = plugin.getConfig().getDouble("deop-on-leave.teleport.z", 0.0);
        float yaw = (float) plugin.getConfig().getDouble("deop-on-leave.teleport.yaw", 0.0);
        float pitch = (float) plugin.getConfig().getDouble("deop-on-leave.teleport.pitch", 0.0);

        return new Location(Bukkit.getWorld(worldName), x, y, z, yaw, pitch);
    }

    public void handleAllOnlinePlayers() {
        for (Player player : Bukkit.getOnlinePlayers()) {
            handlePlayerDeop(player);
        }
    }
}
